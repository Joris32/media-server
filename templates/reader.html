<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ book_name }}</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3/dist/epub.min.js"></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      overflow: hidden;
      background: #ffffff;
      color: #111;
    }

    #viewer {
      position: absolute;
      top: 56px;
      bottom: 0;
      left: 0;
      right: 0;
    }

    #toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 18px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
      z-index: 10;
    }

    #title {
      font-size: 17px;
      font-weight: 600;
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .controls {
      display: flex;
      gap: 8px;
    }

    button {
      border: none;
      background: #e5e7eb;
      color: #111;
      padding: 7px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s ease, transform 0.1s ease;
    }

    button:hover {
      background: #d1d5db;
      transform: translateY(-1px);
    }

    button:active {
      background: #9ca3af;
      transform: translateY(0);
    }

    @media (max-width: 480px) {
      #toolbar {
        height: 64px;
        padding: 0 12px;
      }
      #title {
        font-size: 20px;
      }
      button {
        padding: 12px 16px;
        font-size: 18px;
        border-radius: 8px;
      }
      .controls {
        gap: 12px;
      }
    }
  </style>
</head>

<body>
  <div id="toolbar">
    <div id="title">{{ book_name }}</div>
    <div class="controls">
      <button id="prev">▲</button>
      <button id="next">▼</button>
    </div>
  </div>

  <div id="viewer"></div>

  <script>
    const bookName = "{{ book_name }}";
    const bookUrl  = "{{ book_url }}";
    const keyPos = "epub-location-" + bookName;
    const book = ePub(bookUrl);

    const rendition = book.renderTo("viewer", {
      width: "100%",
      height: "100%",
      flow: "scrolled-doc",
      allowScriptedContent: false
    });

    book.ready.then(() => {
      try { book.locations.generate(1000); } catch(e) {}
      const saved = localStorage.getItem(keyPos);
      if (saved) rendition.display(saved);
      else rendition.display();
      rendition.on("relocated", loc => {
        try { localStorage.setItem(keyPos, loc.start.cfi); } catch(e) {}
      });
    });

    document.getElementById("prev").addEventListener("click", () => rendition.prev());
    document.getElementById("next").addEventListener("click", () => rendition.next());
  </script>
</body>
</html>
